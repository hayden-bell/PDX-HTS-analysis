# Custom scripts for leukemia high-throughput screening quality control and data analysis  

These scripts will analyse quantitative high-throughput drug screening data analysed by image analysis.

Quality control will be performed to help identify any potential systematic errors and quality metrics (including Z' scores) are generated for reporting.

LOESS normalisation will be applied to data to correct for any positional effects (with positional effects being determined by iterative intra-plate row-by-row comparisons by Welch t-tests).

Data are visualised by an interactive plot which displays putative hits (based on drugs at least 2 standard deviations away from the mean) with relevant information.

> **Note** These scripts have not been excessively optimised for efficiency. Rather, they have been quickly modified to be used by others. They can be freely modified as appropriate.
## Contents
* ```Requirements.txt``` contains the required dependencies for the scripts.
* [```1_quality_control.py```](1_quality_control.py) is a pre-processing script which performs quality control metrics and visualisations.
* [```2_analysis_loess.py```](2_analysis_loess.py) is a script which performs statistical analysis and visualisation of screening data.
* [ExampleSample123/...](ExampleSample123/) directory provides example input and output from running the QC and analysis scripts.
  * [```ExampleSample123/control_locs.csv```](ExampleSample123/control_locs.csv) contains the required positive and negative control locations for the drug plates.
  * [```ExampleSample123/raw_data/ExampleSample123_absolute_counts_collated.csv```](ExampleSample123/raw_data/ExampleSample123_absolute_counts_collated.csv) contains an example raw dataset for analysis.
* [plate_maps/...](plate_maps/) contains the drug information and well contents for the full screening libraries.
  * [```plate_maps/APExBIO_FDA_Library_Information.csv```](plate_maps/APExBIO_FDA_Library_Information.csv) details required information and well contents for the FDA-approved drug library.
* [SampleTemplate/...](SampleTemplate/) directory provides a template which can be duplicated for additional samples.
  * [```SampleTemplate/control_locs.csv```](ExampleSample123/control_locs.csv) contains the required positive and negative control locations for the drug plates.
  * [```SampleTemplate/raw_data/SampleTemplate_absolute_counts_collated.csv```](SampleTemplate/raw_data/SampleTemplate_absolute_counts_collated.csv) contains a blank template for data input with correct column headers.


## Getting Started
With absolute cell count data generated by image analysis (*See [https://github.com/hayden-bell/Image_Analysis](https://github.com/hayden-bell/Image_Analysis)*): 
1. Duplicate the SampleTemplate folder and rename '~~SampleTemplate~~' to your sample name.
2. Rename ```SampleTemple_absolute_counts_collated.csv``` to ```YourSampleName_absolute_counts_collated.csv``` and populate with complete raw absolute cell count data.
3. Run ```1_quality_control.py``` in the parental folder and enter the case-sensitive sample name when prompted.
4. Run ```2_analysis_loess.py``` in the parental folder and enter the case-sensitive sample name when prompted.

## Required Files

The following files must be present in a new folder for which analysis should be performed:

1. ```SampleTemplate/raw_data/SampleTemplate_absolute_counts_collated.csv``` should contain all of the raw absolute cell count data for the full screen, including replicates as appropriate.

| Image_Count_LeukaemicNuclei | Image_Count_MSCNuclei | Image_Metadata_Plate | Image_Metadata_Well |
|-----------------------------|-----------------------|----------------------|---------------------|
| ...                         | ...                   | ...                  | ...                 |

2. ```SampleTemplate/control_locs.csv``` contains the positive and negative control well locations present on each plate (excluding some locations which are more prone to positional/edge effects)

## Data outputs
From ```1_quality_control.py```:
* ```data/compiled_ExampleSample123.csv``` - a simple CSV file combining absolute cell counts with respective drug library information.
* ```figures/QC/ExampleSample123_experiment_wide_col_effect.png``` - a figure showing potential experiment-wide column effects.
* ```figures/QC/ExampleSample123_experiment_wide_raw_counts.png``` - a figure showing potential experiment-wide raw count abnormalities between plates.
* ```figures/QC/ExampleSample123_experiment_wide_row_effect.png``` - a figure showing potential experiment-wide row effects.
* ```figures/QC/ExampleSample123_raw_counts_by_control.png``` - a figure showing positive and negative controls on a plate-by-plate basis.
* [figures/QC/heatmaps...](figures/QC/heatmaps) - contains heatmaps for each individual plate to aid visual identification of potential errors.
* ```figures/QC/stats/ExampleSample123_control_stats.csv``` - details descriptive statistics for defined positive and negative controls, in addition to Z' and robust Z' statistical scores on a plate-by-plate basis.

From ```2_analysis_loess.py```:
* ```data/compiled_normalised_ExampleSample123.csv``` - a CSV file combining loess normalisation steps, % of positive control, and % relative viability for each well, plate, and replicate. 
* ```data/ExampleSample123_normalised_aggregated.csv``` - a CSV file showing the mean±SD relative viability for each individual library drug across the replicates.
  * ```data/ExampleSample123_normalised_hits.csv``` - a shortlist of drug hits with mean±SD viability, defined as being > 2SD away from the data set mean.
* ```data/stats/ExampleSample123_row_effects.csv``` - p-values from iterative row-by-row Welch t-tests for each row of each plate.
* ```figures/ExampleSample123_all_normalised_scatterplot.html``` - an interactive figure displaying results for individual drugs and highlighting statistical hits in red. Information about the drugs and the mean±SD viability are revealed upon hover. A sortable table of all results is also generated.
## Dependencies
The script relies on the following dependencies (tested version provided in parentheses):
* python (3.9.8)
* pandas (1.3.4)
* matplotlib (3.5.0)
* seaborn (0.11.2)
* pathlib (1.0.1)
* scipy (1.7.1)
* math (0.0.1)
* numpy (1.21.2)
* bokeh (2.4.2)

Use Anaconda to install the required dependencies. The script can be operated on a standard desktop computer and processes in a matter of seconds.

